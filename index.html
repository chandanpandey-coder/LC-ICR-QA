<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ICR Feedback Form</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
body{font-family:Inter,sans-serif;background:#eef4fa;padding:40px}
.container{max-width:1200px;margin:auto;background:#fff;border-radius:18px;padding:56px}
.section{margin-top:56px}
label{display:block;margin-top:28px;font-weight:600}
select,input,textarea{
  width:100%;margin-top:10px;padding:14px;
  border-radius:10px;border:1px solid #cbd5e1
}
textarea{min-height:120px;resize:vertical}
.hidden{display:none}
button{
  margin-top:60px;padding:10px 26px;
  border:none;border-radius:10px;
  background:#3b82f6;color:#fff;
  cursor:pointer
}
</style>
</head>

<body>
<div class="container">
<h1>ICR â€“ Feedback Form</h1>

<form id="icrForm" novalidate>

<!-- BASIC -->
<div class="section">
<label>Loan Number *</label>
<input name="LoanNumber" required>
<label>Reviewer Name *</label>
<input name="ReviewerName" required>
</div>

<!-- LOAN TYPE -->
<div class="section">
<label>Loan Type *</label>
<select name="LoanType" onchange="toggleLoan(this.value)" required>
<option value="">- Select -</option>
<option value="Refi">Refi</option>
<option value="Purchase">Purchase</option>
</select>
</div>

<!-- ========================== REFI ========================== -->
<div id="refiSection" class="hidden">

<div class="section">
<label>Are Entity documents received (except OA/Bylaws)? *</label>
<select name="Refi_EntityDocs" onchange="entityDocs(this,'refi')" required>
<option value="">- Select -</option>
<option>Yes</option>
<option>No</option>
</select>
</div>

<div id="refiEntityCorrect" class="section hidden">
<label>Is Entity Data entered correctly? *</label>
<select name="Refi_EntityCorrect" onchange="entityCorrect(this,'refi')">
<option value="">- Select -</option>
<option>Yes</option>
<option>No</option>
</select>
</div>

<div id="refiEntityDetails" class="section hidden">
<label>EIN updated? *</label>
<select name="Refi_EIN"><option value="">- Select -</option><option>Yes</option><option>No</option></select>

<label>Formation updated? *</label>
<select name="Refi_Formation"><option value="">- Select -</option><option>Yes</option><option>No</option></select>

<label>COGS updated? *</label>
<select name="Refi_COGS"><option value="">- Select -</option><option>Yes</option><option>No</option><option>N/A</option></select>

<label>Foreign Registration updated? *</label>
<select name="Refi_Foreign"><option value="">- Select -</option><option>Yes</option><option>No</option><option>N/A</option></select>
</div>

<div class="section">
<label>Are OA / Bylaws received? *</label>
<select name="Refi_OA" onchange="toggleOA(this,'refi')" required>
<option value="">- Select -</option>
<option>Yes</option>
<option>No</option>
</select>

<div id="refiOA" class="hidden">
<label>OA highlighted correctly? *</label>
<select name="Refi_OA_Highlighted"><option value="">- Select -</option><option>Yes</option><option>No</option></select>

<label>Signature updated correctly? *</label>
<select name="Refi_Signature"><option value="">- Select -</option><option>Yes</option><option>No</option></select>
</div>
</div>

<div id="refiChildGate" class="section hidden">
<label>Closing Entity Type *</label>
<select name="Refi_Child_Type" onchange="toggleSection(this,'refiChild','Child Entity')">
<option value="">- Select -</option>
<option>No Child Entity</option>
<option>Child Entity</option>
</select>

<div id="refiChild" class="hidden">
<label>Child Entity info updated? *</label>
<select name="Refi_Child_Info"><option value="">- Select -</option><option>Yes</option><option>No</option></select>
</div>
</div>

<div class="section">
<label>Is Payoff received? *</label>
<select name="Refi_Payoff" onchange="toggleSection(this,'refiPayoff','Yes')" required>
<option value="">- Select -</option>
<option>Yes</option>
<option>No</option>
<option>N/A</option>
</select>

<div id="refiPayoff" class="hidden">
<label>Payoff Good Through updated? *</label>
<select name="Refi_Payoff_GT"><option value="">- Select -</option><option>Yes</option><option>No</option></select>
</div>
</div>

<div class="section">
<label>Is Appraisal received? *</label>
<select name="Refi_Appraisal" onchange="toggleSection(this,'refiOOR','Yes')" required>
<option value="">- Select -</option>
<option>Yes</option>
<option>No</option>
</select>

<div id="refiOOR" class="hidden">
<label>OOR updated correctly? *</label>
<select name="Refi_OOR"><option value="">- Select -</option><option>Yes</option><option>No</option></select>
</div>
</div>

</div>

<!-- ========================== PURCHASE ========================== -->
<div id="purchaseSection" class="hidden">

<div class="section">
<label>Are Entity documents received (except OA/Bylaws)? *</label>
<select name="Pur_EntityDocs" onchange="entityDocs(this,'purchase')" required>
<option value="">- Select -</option>
<option>Yes</option>
<option>No</option>
</select>
</div>

<div id="purchaseEntityCorrect" class="section hidden">
<label>Is Entity Data entered correctly? *</label>
<select name="Pur_EntityCorrect" onchange="entityCorrect(this,'purchase')">
<option value="">- Select -</option>
<option>Yes</option>
<option>No</option>
</select>
</div>

<div id="purchaseEntityDetails" class="section hidden">
<label>EIN updated? *</label>
<select name="Pur_EIN"><option value="">- Select -</option><option>Yes</option><option>No</option></select>

<label>Formation updated? *</label>
<select name="Pur_Formation"><option value="">- Select -</option><option>Yes</option><option>No</option></select>

<label>COGS updated? *</label>
<select name="Pur_COGS"><option value="">- Select -</option><option>Yes</option><option>No</option><option>N/A</option></select>

<label>Foreign Registration updated? *</label>
<select name="Pur_Foreign"><option value="">- Select -</option><option>Yes</option><option>No</option><option>N/A</option></select>
</div>

<div class="section">
  <label>Are OA / Bylaws received? *</label>
  <select name="Pur_OA" onchange="toggleOA(this,'purchase')" required>
    <option value="">- Select -</option>
    <option>Yes</option>
    <option>No</option>
  </select>

  <div id="purchaseOA" class="hidden">
    <label>OA highlighted correctly? *</label>
    <select name="Pur_OA_Highlighted">
      <option value="">- Select -</option>
      <option>Yes</option>
      <option>No</option>
    </select>

    <label>Signature updated correctly? *</label>
    <select name="Pur_Signature">
      <option value="">- Select -</option>
      <option>Yes</option>
      <option>No</option>
    </select>
  </div>
</div>


<div id="purchaseChildGate" class="section hidden">
<label>Closing Entity Type *</label>
<select name="Pur_Child_Type" onchange="toggleSection(this,'purchaseChild','Child Entity')">
<option value="">- Select -</option>
<option>No Child Entity</option>
<option>Child Entity</option>
</select>

<div id="purchaseChild" class="hidden">
<label>Child Entity info updated? *</label>
<select name="Pur_Child_Info"><option value="">- Select -</option><option>Yes</option><option>No</option></select>
</div>
</div>

<div class="section">
<label>Is Purchase Contract received? *</label>
<select name="Pur_Contract" onchange="toggleSection(this,'purchaseACD','Yes')" required>
<option value="">- Select -</option>
<option>Yes</option>
<option>No</option>
</select>

<div id="purchaseACD" class="hidden">
<label>Is ACD updated correctly? *</label>
<select name="Pur_ACD"><option value="">- Select -</option><option>Yes</option><option>No</option></select>
</div>
</div>

<div class="section">
<label>Is Appraisal received? *</label>
<select name="Pur_Appraisal" onchange="toggleSection(this,'purchaseOOR','Yes')" required>
<option value="">- Select -</option>
<option>Yes</option>
<option>No</option>
<option>N/A</option>
</select>

<div id="purchaseOOR" class="hidden">
<label>OOR updated correctly? *</label>
<select name="Pur_OOR"><option value="">- Select -</option><option>Yes</option><option>No</option></select>
</div>
</div>

</div>

<!-- FINAL QUESTIONS -->
<div class="section">
<label>Is the Follow up Done? *</label>
<select name="Follow_Up_Done" required><option value="">- Select -</option><option>Yes</option><option>No</option></select>

<label>Are the Comments Updated? *</label>
<select name="Comments_Updated" required><option value="">- Select -</option><option>Yes</option><option>No</option></select>

<label>Is the Deal Name updated? *</label>
<select name="Deal_Name_Updated" required><option value="">- Select -</option><option>Yes</option><option>No</option></select>
</div>

<div class="section">
<label>Comments *</label>
<textarea name="Final_Comments" required></textarea>
</div>

<input type="hidden" name="Final_Score" id="Final_Score">

<button type="submit">Submit</button>
</form>
</div>

<script>
/* ===================== SCORING LOGIC ONLY ===================== */

function scoreEntity(prefix){
  const docs = document.querySelector(`[name="${prefix}_EntityDocs"]`)?.value;
  if(docs !== "Yes") return {score:0, weight:0};

  const correct = document.querySelector(`[name="${prefix}_EntityCorrect"]`)?.value;
  if(correct === "Yes") return {score:10, weight:10};

  if(correct !== "No") return {score:0, weight:0};

  const fields = ["EIN","Formation","COGS","Foreign"];
  let applicable = 0, correctCount = 0;

  fields.forEach(f=>{
    const v = document.querySelector(`[name="${prefix}_${f}"]`)?.value;
    if(v && v !== "N/A"){
      applicable++;
      if(v === "Yes") correctCount++;
    }
  });

  if(applicable === 0) return {score:0, weight:0};

  return {
    score: +(10 * correctCount / applicable).toFixed(2),
    weight: 10
  };
}

function scoreYesNo(name, points){
  const v = document.querySelector(`[name="${name}"]`)?.value;
  if(v === "Yes") return {score:points, weight:points};
  if(v === "No" || v === "N/A") return {score:0, weight:0};
  return {score:0, weight:0};
}

function calculateFinalScore(){
  let totalScore = 0;
  let totalWeight = 0;

  const loanType = document.querySelector('[name="LoanType"]').value;

  const prefix = loanType === "Refi" ? "Refi" : "Pur";

  const entity = scoreEntity(prefix);
  totalScore += entity.score;
  totalWeight += entity.weight;

  [
    `${prefix}_OA`,
    `${prefix}_Payoff`,
    `${prefix}_Appraisal`,
    `${prefix}_Contract`
  ].forEach(q=>{
    const r = scoreYesNo(q,10);
    totalScore += r.score;
    totalWeight += r.weight;
  });

  [
    "Follow_Up_Done",
    "Comments_Updated",
    "Deal_Name_Updated"
  ].forEach(q=>{
    const r = scoreYesNo(q,10);
    totalScore += r.score;
    totalWeight += r.weight;
  });

  const finalScore = totalWeight === 0 ? 0 : +(totalScore / totalWeight * 100).toFixed(2);
  document.getElementById("Final_Score").value = finalScore;
}

/* ===================== EXISTING SUBMIT (UNCHANGED) ===================== */
document.getElementById("icrForm").addEventListener("submit", function(e){
  e.preventDefault();
  calculateFinalScore();

  fetch(
    "https://script.google.com/macros/s/AKfycbw70gSfTiEYZdXxeXZG6G3i63tQJDSUaex3RJh9HSLzsQrV5dJ1HCHhYmRkISbnBXo43Q/exec",
    {
      method: "POST",
      mode: "no-cors",
      body: new FormData(this)
    }
  );

  alert("Form submitted successfully");
  this.reset();
});
</script>
</body>
</html>
