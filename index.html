<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ICR Feedback Form</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
body{font-family:Inter,sans-serif;background:#eef4fa;padding:40px}
.container{max-width:1200px;margin:auto;background:#fff;border-radius:18px;padding:56px}
.section{margin-top:56px}
label{display:block;margin-top:28px;font-weight:600}
select,input,textarea{
  width:100%;margin-top:10px;padding:14px;
  border-radius:10px;border:1px solid #cbd5e1
}
textarea{min-height:120px;resize:vertical}
.hidden{display:none}
button{
  margin-top:60px;padding:10px 26px;
  border:none;border-radius:10px;
  background:#3b82f6;color:#fff;
  cursor:pointer
}
button:disabled{background:#94a3b8;cursor:not-allowed;}
</style>
</head>

<body>
<div class="container">
<h1>ICR â€“ Feedback Form</h1>

<form id="icrForm" novalidate>

<div class="section">
<label>Loan Number *</label>
<input name="LoanNumber" required>

<label>Reviewer Name *</label>
<input name="ReviewerName" required>
</div>

<div class="section">
<label>Loan Type *</label>
<select name="LoanType" onchange="toggleLoan(this.value)" required>
<option value="">- Select -</option>
<option value="Refi">Refi</option>
<option value="Purchase">Purchase</option>
</select>
</div>

<div id="refiSection" class="hidden">

<div class="section">
<label>Are Entity documents received (except OA/Bylaws)? *</label>
<select name="Refi_EntityDocs" onchange="entityDocs(this,'Refi')" required>
<option value="">- Select -</option>
<option>Yes</option>
<option>No</option>
</select>
</div>

<div id="RefiEntityCorrect" class="section hidden">
<label>Is Entity Data entered correctly? *</label>
<select name="Refi_EntityCorrect" onchange="entityCorrect(this,'Refi')">
<option value="">- Select -</option>
<option>Yes</option>
<option>No</option>
</select>
</div>

<div id="RefiEntityDetails" class="section hidden">
<label>EIN updated? *</label>
<select name="Refi_EIN"><option value="">- Select -</option><option>Yes</option><option>No</option></select>

<label>Formation updated? *</label>
<select name="Refi_Formation"><option value="">- Select -</option><option>Yes</option><option>No</option></select>

<label>COGS updated? *</label>
<select name="Refi_COGS"><option value="">- Select -</option><option>Yes</option><option>No</option><option>N/A</option></select>

<label>Foreign Registration updated? *</label>
<select name="Refi_Foreign"><option value="">- Select -</option><option>Yes</option><option>No</option><option>N/A</option></select>
</div>

<div class="section">
<label>Are OA / Bylaws received? *</label>
<select name="Refi_OA" onchange="toggleOA(this,'Refi')" required>
<option value="">- Select -</option>
<option>Yes</option>
<option>No</option>
</select>

<div id="RefiOA" class="hidden">
<label>OA highlighted correctly? *</label>
<select name="Refi_OA_Highlighted"><option value="">- Select -</option><option>Yes</option><option>No</option></select>

<label>Signature updated correctly? *</label>
<select name="Refi_Signature"><option value="">- Select -</option><option>Yes</option><option>No</option></select>
</div>
</div>

<div id="RefiChildGate" class="section hidden">
<label>Closing Entity Type *</label>
<select name="Refi_Child_Type" onchange="toggleSection(this,'RefiChild','Child Entity')">
<option value="">- Select -</option>
<option>No Child Entity</option>
<option>Child Entity</option>
</select>

<div id="RefiChild" class="hidden">
<label>Child Entity info updated? *</label>
<select name="Refi_Child_Info"><option value="">- Select -</option><option>Yes</option><option>No</option></select>
</div>
</div>

<div class="section">
<label>Is Payoff received? *</label>
<select name="Refi_Payoff" onchange="toggleSection(this,'RefiPayoff','Yes')" required>
<option value="">- Select -</option>
<option>Yes</option>
<option>No</option>
<option>N/A</option>
</select>

<div id="RefiPayoff" class="hidden">
<label>Payoff Good Through updated? *</label>
<select name="Refi_Payoff_GT"><option value="">- Select -</option><option>Yes</option><option>No</option></select>
</div>
</div>

<div class="section">
<label>Is Appraisal received? *</label>
<select name="Refi_Appraisal" onchange="toggleSection(this,'RefiOOR','Yes')" required>
<option value="">- Select -</option>
<option>Yes</option>
<option>No</option>
</select>

<div id="RefiOOR" class="hidden">
<label>OOR updated correctly? *</label>
<select name="Refi_OOR"><option value="">- Select -</option><option>Yes</option><option>No</option></select>
</div>
</div>

</div>

<div id="purchaseSection" class="hidden">

<div class="section">
<label>Are Entity documents received (except OA/Bylaws)? *</label>
<select name="Pur_EntityDocs" onchange="entityDocs(this,'Pur')" required>
<option value="">- Select -</option>
<option>Yes</option>
<option>No</option>
</select>
</div>

<div id="PurEntityCorrect" class="section hidden">
<label>Is Entity Data entered correctly? *</label>
<select name="Pur_EntityCorrect" onchange="entityCorrect(this,'Pur')">
<option value="">- Select -</option>
<option>Yes</option>
<option>No</option>
</select>
</div>

<div id="PurEntityDetails" class="section hidden">
<label>EIN updated? *</label>
<select name="Pur_EIN"><option value="">- Select -</option><option>Yes</option><option>No</option></select>

<label>Formation updated? *</label>
<select name="Pur_Formation"><option value="">- Select -</option><option>Yes</option><option>No</option></select>

<label>COGS updated? *</label>
<select name="Pur_COGS"><option value="">- Select -</option><option>Yes</option><option>No</option><option>N/A</option></select>

<label>Foreign Registration updated? *</label>
<select name="Pur_Foreign"><option value="">- Select -</option><option>Yes</option><option>No</option><option>N/A</option></select>
</div>

<div class="section">
<label>Are OA / Bylaws received? *</label>
<select name="Pur_OA" onchange="toggleOA(this,'Pur')" required>
<option value="">- Select -</option>
<option>Yes</option>
<option>No</option>
</select>

<div id="PurOA" class="hidden">
<label>OA highlighted correctly? *</label>
<select name="Pur_OA_Highlighted"><option value="">- Select -</option><option>Yes</option><option>No</option></select>

<label>Signature updated correctly? *</label>
<select name="Pur_Signature"><option value="">- Select -</option><option>Yes</option><option>No</option></select>
</div>
</div>

<div id="PurChildGate" class="section hidden">
<label>Closing Entity Type *</label>
<select name="Pur_Child_Type" onchange="toggleSection(this,'PurChild','Child Entity')">
<option value="">- Select -</option>
<option>No Child Entity</option>
<option>Child Entity</option>
</select>

<div id="PurChild" class="hidden">
<label>Child Entity info updated? *</label>
<select name="Pur_Child_Info"><option value="">- Select -</option><option>Yes</option><option>No</option></select>
</div>
</div>

<div class="section">
<label>Is Purchase Contract received? *</label>
<select name="Pur_Contract" onchange="toggleSection(this,'PurACD','Yes')" required>
<option value="">- Select -</option>
<option>Yes</option>
<option>No</option>
</select>

<div id="PurACD" class="hidden">
<label>Is ACD updated correctly? *</label>
<select name="Pur_ACD"><option value="">- Select -</option><option>Yes</option><option>No</option></select>
</div>
</div>

<div class="section">
<label>Is Appraisal received? *</label>
<select name="Pur_Appraisal" onchange="toggleSection(this,'PurOOR','Yes')" required>
<option value="">- Select -</option>
<option>Yes</option>
<option>No</option>
<option>N/A</option>
</select>

<div id="PurOOR" class="hidden">
<label>OOR updated correctly? *</label>
<select name="Pur_OOR"><option value="">- Select -</option><option>Yes</option><option>No</option></select>
</div>
</div>

</div>

<div class="section">
<label>Is the Follow up Done? *</label>
<select name="Follow_Up_Done" required><option value="">- Select -</option><option>Yes</option><option>No</option></select>

<label>Are the Comments Updated? *</label>
<select name="Comments_Updated" required><option value="">- Select -</option><option>Yes</option><option>No</option></select>

<label>Is the Deal Name updated? *</label>
<select name="Deal_Name_Updated" required><option value="">- Select -</option><option>Yes</option><option>No</option></select>
</div>

<div class="section">
<label>Comments *</label>
<textarea name="Final_Comments" required></textarea>
</div>

<input type="hidden" name="Final_Score" id="Final_Score">

<button type="submit">Submit</button>
</form>
</div>

<script>
/* ===================== DISPLAY & UI LOGIC ===================== */
function setRequired(section, state) {
  section.querySelectorAll("select,input,textarea").forEach(el => el.required = state);
}

function toggleLoan(v) {
  const refi = document.getElementById("refiSection");
  const pur = document.getElementById("purchaseSection");
  
  refi.classList.toggle("hidden", v !== "Refi");
  pur.classList.toggle("hidden", v !== "Purchase");
  
  setRequired(refi, v === "Refi");
  setRequired(pur, v === "Purchase");
}

function toggleSection(el, id, val) {
  const sec = document.getElementById(id);
  const show = el.value === val;
  if(sec) {
    sec.classList.toggle("hidden", !show);
    setRequired(sec, show);
  }
}

function toggleOA(el, type) {
  const show = el.value === "Yes";
  // Toggle OA Sub-section and Child Gate
  ["OA", "ChildGate"].forEach(s => {
    const sec = document.getElementById(type + s);
    if(sec) {
      sec.classList.toggle("hidden", !show);
      setRequired(sec, show);
    }
  });
}

function entityDocs(el, type) {
  const sec = document.getElementById(type + "EntityCorrect");
  sec.classList.toggle("hidden", el.value !== "Yes");
  setRequired(sec, el.value === "Yes");

  const det = document.getElementById(type + "EntityDetails");
  det.classList.add("hidden");
  setRequired(det, false);
}

function entityCorrect(el, type) {
  const det = document.getElementById(type + "EntityDetails");
  det.classList.toggle("hidden", el.value !== "No");
  setRequired(det, el.value === "No");
}

/* ===================== SCORING LOGIC ===================== */

// Helper to get value safely
function getVal(name) {
  const el = document.querySelector(`[name="${name}"]`);
  return el ? el.value : "";
}

// 1. ENTITY SCORE (Unchanged Logic)
function scoreEntity(prefix) {
  if (getVal(`${prefix}_EntityDocs`) !== "Yes") return {s: 0, w: 0};
  
  const correct = getVal(`${prefix}_EntityCorrect`);
  if (correct === "Yes") return {s: 10, w: 10};
  if (correct !== "No") return {s: 0, w: 0};

  const fields = ["EIN", "Formation", "COGS", "Foreign"];
  let applicable = 0, correctCount = 0;
  
  fields.forEach(f => {
    const v = getVal(`${prefix}_${f}`);
    if (v && v !== "N/A") {
      applicable++;
      if (v === "Yes") correctCount++;
    }
  });

  if (applicable === 0) return {s: 0, w: 0};
  return {s: (10 * correctCount / applicable), w: 10};
}

// 2. PENALTY SCORING HELPER
// Used for sub-questions (Action items)
// Yes = Full Points, Full Weight
// No = 0 Points, Full Weight (Deduction)
function scorePenalty(name, maxPoints) {
  const v = getVal(name);
  if (v === "Yes") return {s: maxPoints, w: maxPoints};
  if (v === "No") return {s: 0, w: maxPoints}; // Deduct score (add weight, 0 score)
  return {s: 0, w: 0}; // N/A or Empty -> Redistribute (0 weight)
}

// 3. OA SCORING (Complex Logic)
function scoreOA(prefix) {
  // Gatekeeper: Is OA Received?
  // If No -> Redistribute (Return 0,0)
  if (getVal(`${prefix}_OA`) !== "Yes") return {s: 0, w: 0};

  let s = 0, w = 0;

  // 1. OA Highlighted Correctly?
  const hl = scorePenalty(`${prefix}_OA_Highlighted`, 10);
  s += hl.s; w += hl.w;

  // 2. Signature Updated Correctly?
  const sig = scorePenalty(`${prefix}_Signature`, 10);
  s += sig.s; w += sig.w;

  // 3. Child Entity Logic
  const childType = getVal(`${prefix}_Child_Type`);
  if (childType === "Child Entity") {
    const cInfo = scorePenalty(`${prefix}_Child_Info`, 10);
    s += cInfo.s; w += cInfo.w;
  }
  // If "No Child Entity", we simply do not add weight (Redistribute automatically)

  return {s: s, w: w};
}

// 4. PAYOFF SCORING
function scorePayoff(prefix) {
  if (getVal(`${prefix}_Payoff`) !== "Yes") return {s: 0, w: 0};
  // If received, check Good Through date
  return scorePenalty(`${prefix}_Payoff_GT`, 10);
}

// 5. CONTRACT SCORING
function scoreContract(prefix) {
  if (getVal(`${prefix}_Contract`) !== "Yes") return {s: 0, w: 0};
  // If received, check ACD
  return scorePenalty(`${prefix}_ACD`, 10);
}

// 6. APPRAISAL SCORING
function scoreAppraisal(prefix) {
  if (getVal(`${prefix}_Appraisal`) !== "Yes") return {s: 0, w: 0};
  // If received, check OOR
  return scorePenalty(`${prefix}_OOR`, 10);
}

// MAIN CALCULATION
function calculateFinalScore() {
  let score = 0, weight = 0;
  const loanType = getVal("LoanType");
  const p = loanType === "Refi" ? "Refi" : "Pur";

  // A. Entity Section
  const ent = scoreEntity(p);
  score += ent.s; weight += ent.w;

  // B. OA Section (Handles Highlight, Signature, Child Info)
  const oa = scoreOA(p);
  score += oa.s; weight += oa.w;

  // C. Conditional Sections based on Loan Type
  if (loanType === "Refi") {
    // Payoff
    const pay = scorePayoff(p);
    score += pay.s; weight += pay.w;
    // Appraisal
    const app = scoreAppraisal(p);
    score += app.s; weight += app.w;
  } 
  else if (loanType === "Purchase") {
    // Contract
    const con = scoreContract(p);
    score += con.s; weight += con.w;
    // Appraisal
    const app = scoreAppraisal(p);
    score += app.s; weight += app.w;
  }

  // D. Final Mandatory Questions (FollowUp, Comments, DealName)
  // Logic: No = Deduct (0/5)
  ["Follow_Up_Done", "Comments_Updated", "Deal_Name_Updated"].forEach(q => {
    const r = scorePenalty(q, 5);
    score += r.s; weight += r.w;
  });

  // Final Calc
  document.getElementById("Final_Score").value =
    weight === 0 ? 0 : +(score / weight * 100).toFixed(2);
}

/* SUBMIT HANDLER */
document.getElementById("icrForm").addEventListener("submit", function(e) {
  e.preventDefault();

  try {
    calculateFinalScore();
  } catch(err) {
    console.error("Calculation Error", err);
    alert("Error calculating score. Please check all fields.");
    return;
  }

  const btn = this.querySelector("button");
  const originalText = btn.innerText;
  btn.innerText = "Submitting...";
  btn.disabled = true;

  fetch(
    "https://script.google.com/macros/s/AKfycbzxVt6fckkcaV59S5MGVXI-tshqNQGehFiFf3U9_vnKpuQ_UAGDqfKf0EXEYPKQO-WU/exec",
    {method: "POST", mode: "no-cors", body: new FormData(this)}
  )
  .then(() => {
    alert("Form submitted successfully");
    this.reset();
    document.getElementById("refiSection").classList.add("hidden");
    document.getElementById("purchaseSection").classList.add("hidden");
    document.getElementById("Final_Score").value = "";
  })
  .catch(() => {
    alert("Submission failed. Please check internet connection.");
  })
  .finally(() => {
    btn.innerText = originalText;
    btn.disabled = false;
  });
});
</script>
</body>
</html>
